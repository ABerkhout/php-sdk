<?php
define('SDK_ROOT', dirname(dirname(__FILE__)));

function findExamples() {
  return glob(SDK_ROOT.'/example/*.php');
}

function parseExample($file) {
  $php = file_get_contents($file);
  preg_match('/\/\*(.+?)\*\/\n(.+)/s', $php, $match);
  list(, $markdown, $code) = $match;

  $code = join("\n", array(
    '<?php',
    $code
  ));
  $code = preg_replace('/^.+$/m', '    $0', $code);
  return $markdown."\n".$code;
}

$examples = array();
$files = findExamples();
foreach ($files as $file) {
  $example = parseExample($file);
  $examples[] = $example;
}

$readmePath = SDK_ROOT.'/Readme.md';
$readme = file_get_contents($readmePath);
$exampleDocs = join("\n", $examples);

$readme = preg_replace(
  '/(generated by: make docs[^\n]+\n).+(\n<!--)/is',
  '$1'.$exampleDocs.'$2',
  $readme
);

file_put_contents($readmePath, $readme);
